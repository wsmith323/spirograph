Plan-Id: 2026-02-25_171254Z-curve-guidance-accuracy-density-heuristic

# Curve Guidance Accuracy + Density Heuristic (Console UI)

## Summary

Improve the accuracy and usefulness of console UI guidance by replacing the
current ratio-heavy qualitative descriptions with a parameter-aware visual
heuristic that uses closure structure (`gcd`, laps, spins), `R/r`, `d/r`, and
curve type.

This pass updates both:
- Post-selection `Curve guidance` output (`describe_curve()`)
- Manual-entry helper text shown while choosing `R`, `r`, and `d`

No generator math or rendering behavior changes.

## Goals and Success Criteria

- Make guidance less misleading, especially around “denseness” and “lobes.”
- Replace overconfident claims with type-aware, estimate-based wording.
- Add a practical visual density estimate (`Low`/`Medium`/`High`/`Very High`).
- Keep console UI workflows unchanged (manual/random generation still behave the
  same).
- Keep all calculations aligned with current integer/GCD closure semantics used
  in generation.

## In Scope

- `/Users/warren/work/projects/spirograph/spirograph/console_ui/guidance.py`
- Optional small pure helpers extracted into `guidance.py` (same file)
- New tests under `tests/spirograph/console_ui/` for heuristic helpers/output
  classification
- Minor wording-only updates in `main.py` only if needed to present new guidance
  labels consistently (not expected)

## Out of Scope

- Generator behavior/math changes
- Render plan or renderer behavior changes
- Persistence or UI workflow changes
- Reworking the console menu system (already handled in prior pass)

## Public APIs / Interfaces / Types

- No changes to generation/rendering/orchestration public APIs.
- `describe_curve(request)` remains the console UI entrypoint for post-selection
  guidance.
- New helper functions in `guidance.py` may be added as internal utilities
  (pure functions) and tested directly.

## Design Decisions (Locked)

## 1. Replace “approx lobes” with closure-structure messaging

Current issue:
- `fixed // gcd` is presented as “approx lobes,” which is often misleading,
  especially for epitrochoids and loopy/high-offset cases.

Change:
- Remove/stop emphasizing “approx lobes.”
- Replace with:
  - `Closure repeats: laps~X, spins~Y`
  - `Closure structure: simple / moderate / complex` (derived from repeat counts)
  - Optional symmetry feel estimate (separate from density)

## 2. Add explicit visual density estimate (heuristic, not geometric fact)

Implement a density scoring helper using integer closure semantics:

Inputs:
- `fixed_int = int(request.fixed_radius)`
- `rolling_int = int(request.rolling_radius)`
- `gcd_value = math.gcd(fixed_int, rolling_int)` (guard `>= 1`)
- `laps_to_close = rolling_int // gcd_value` (guard `>= 1`)
- `spins_to_close`:
  - hypotrochoid: `max(1, abs(fixed_int - rolling_int) // gcd_value)`
  - epitrochoid: `max(1, (fixed_int + rolling_int) // gcd_value)`
- `ratio = R / r` (float)
- `offset_factor = d / r` (float)

### Density Score Formula (exact)

Define components:

- `closure_score = 0.6 * laps_to_close + 0.4 * spins_to_close`

- `ratio_factor` (clamped):
  - `ratio_scaled = max(0.0, min(2.0, (ratio - 1.0) / 3.0))`
  - `ratio_factor = 0.7 + 0.15 * ratio_scaled`

- `offset_band_weight`:
  - `offset_factor < 0.3` -> `0.2`
  - `0.3 <= offset_factor < 0.9` -> `0.6`
  - `0.9 <= offset_factor < 1.2` -> `1.0`
  - `1.2 <= offset_factor < 1.8` -> `1.5`
  - `offset_factor >= 1.8` -> `1.8`

- `offset_factor_multiplier = 0.8 + 0.2 * offset_band_weight`

Total:
- `density_score = closure_score * ratio_factor * offset_factor_multiplier`

### Density Buckets (exact)

- `Low`: `density_score < 8`
- `Medium`: `8 <= density_score < 25`
- `High`: `25 <= density_score < 80`
- `Very High`: `density_score >= 80`

Output label:
- `Visual density estimate: <bucket> (heuristic)`

## 3. Separate density, symmetry, and offset behavior in wording

Guidance lines will be split into independent dimensions:

- `Curve type` (inside/outside rolling)
- `Closure repeats` (laps/spins)
- `Symmetry feel` (based on repeat counts + ratio closeness to integer)
- `Offset behavior` (soft/spiky/loopy)
- `Visual density estimate` (bucket + short reason)

Reason:
- “Symmetric” and “dense” are not the same.
- Current guidance conflates these.

## 4. Make curve-type-aware language

Use different explanatory wording for hypo vs epi:
- Hypotrochoid:
  - emphasize inner rolling and internal loop/spike transitions
- Epitrochoid:
  - emphasize outer rolling and larger outward loops / broader envelopes

The same density score logic is reused; only descriptive wording changes.

## 5. Make uncertainty explicit in all qualitative claims

Use terms like:
- `likely`, `tends to`, `heuristic`, `visual estimate`

Avoid:
- definitive claims about exact lobe counts or precise geometry interpretation.

## Output Spec (Decision Complete)

## A. New `describe_curve()` output structure

Keep the `Curve guidance:` header and print lines in this order:

1. `Curve type: ...`
2. `Closure repeats: laps~X, spins~Y (closure structure: <simple|moderate|complex>)`
3. `Radius ratio R/r: <ratio> (<coarse complexity note>)`
4. `Offset factor d/r: <offset_factor> (<soft|classic-spiky|loopy|chaotic tendency>)`
5. `Symmetry feel: <strong|moderate|weak> (heuristic)`
6. `Visual density estimate: <Low|Medium|High|Very High> (heuristic)`
7. `Notes: <1 short line combining dominant drivers>` (optional if concise)

Formatting remains plain console text, no color.

## B. Manual-entry guidance changes (`guide_before_*` functions)

### `guide_before_rolling_radius(...)`
Replace “approx lobes” language with:
- current/previewed `R/r`
- closure repeats preview (`laps`, and optionally `spins` if cheap to compute)
- statement that closure repeats and offset (`d/r`) affect visual density more
  than ratio alone

### `guide_before_pen_offset(...)`
Emphasize:
- `d/r` changes visual style (soft -> spiky -> loopy)
- closure repeats (`laps/spins`) are already set mostly by `R` and `r`
- final density is a combination of closure repeats + `d/r`

Retain integer-like ratio note, but phrase as “symmetry tendency,” not density.

### `guide_before_fixed_radius(...)`
Mostly unchanged; may add a brief note that `R` also influences ratio and closure
with the later `r` choice.

## Helper Functions to Add (Pure, in `guidance.py`)

Add pure helpers so logic is testable:

- `compute_curve_repeat_metrics(request: CircularSpiroRequest) -> RepeatMetrics`
  - dataclass with `gcd_value`, `laps_to_close`, `spins_to_close`, `ratio`,
    `offset_factor`

- `compute_density_score(metrics: RepeatMetrics) -> float`

- `classify_density(score: float) -> str`
  - returns `Low|Medium|High|Very High`

- `classify_closure_structure(laps: int, spins: int) -> str`
  - `simple|moderate|complex` (exact thresholds below)

- `classify_symmetry_feel(metrics: RepeatMetrics) -> str`
  - `strong|moderate|weak` heuristic

- `describe_offset_tendency(offset_factor: float, curve_type: SpiroType) -> str`
  - returns short wording fragment

Exact closure structure thresholds:
- `simple`: `max(laps, spins) < 8`
- `moderate`: `8 <= max(laps, spins) < 30`
- `complex`: `max(laps, spins) >= 30`

Exact symmetry feel heuristic:
- Compute `ratio_nearest_int_distance = abs(ratio - round(ratio))`
- Start from `moderate`
- `strong` if:
  - `ratio_nearest_int_distance < 0.08` and `max(laps, spins) <= 40`
- `weak` if:
  - `ratio_nearest_int_distance >= 0.20` and `max(laps, spins) >= 20`
- Otherwise `moderate`

(Heuristic only; wording must include `(heuristic)`.)

## Implementation Steps

1. Refactor `spirograph/console_ui/guidance.py` into testable pure helpers plus
   thin print functions (`describe_curve`, `guide_before_*`)
2. Implement repeat metrics + density score + classification helpers (exact
   formulas/thresholds above)
3. Rewrite `describe_curve()` output lines to the new structure and wording
4. Rewrite `guide_before_rolling_radius()` and `guide_before_pen_offset()`
   messaging to remove “approx lobes” claims and align with density/symmetry
   terminology
5. Apply minor wording adjustment in `guide_before_fixed_radius()` (optional,
   only if needed for consistency)
6. Add automated tests under `tests/spirograph/console_ui/test_guidance.py`
   covering the pure helpers and representative classifications
7. Run targeted tests, then full test suite
8. Stage changes in git (`git add ...`)
9. Run the `capture-last-plan` skill to persist this plan

## Test Cases and Scenarios

## Automated tests (pytest)

Create `/Users/warren/work/projects/spirograph/tests/spirograph/console_ui/test_guidance.py`
with targeted tests for pure helpers only.

### Repeat metrics tests
- Hypotrochoid metrics use integer/GCD closure semantics
- Epitrochoid metrics compute spins with `R + r`
- Handles valid float radii by matching integer-cast semantics used elsewhere

### Density score / bucket tests
- Low-density example (small repeats, low `d/r`)
- Medium-density example
- High-density example
- Very-high-density example
- Boundary tests near thresholds (`8`, `25`, `80`) for deterministic bucketing

### Classification helper tests
- Closure structure classification (`simple`, `moderate`, `complex`)
- Symmetry feel classification (`strong`, `moderate`, `weak`) using constructed
  metric values
- Offset tendency wording buckets for both curve types

### Output-smoke tests (optional, lightweight)
- Capture `describe_curve()` stdout for one hypo and one epi request; assert key
  labels exist:
  - `Closure repeats`
  - `Symmetry feel`
  - `Visual density estimate`
  - no `approx lobes`

## Manual Scenarios (Console UI)

- Generate a simple low-density hypotrochoid and inspect guidance wording
- Generate a high-repeat/high-offset curve and verify density estimate rises
- Compare hypo vs epi with similar `R`, `r`, `d` and confirm type-aware wording
- In manual mode, check `r` step guidance no longer claims “approx lobes”
- In manual mode, check `d` step guidance explains density as combined effect

## Validation Commands (Plan Defaults)

- Targeted:
  - `VIRTUAL_ENV=~/work/virtualenvs/spirograph ./scripts/test tests/spirograph/console_ui/test_guidance.py -q`
- Full suite:
  - `VIRTUAL_ENV=~/work/virtualenvs/spirograph ./scripts/test -q`

## Risks / Regression Potential

- Heuristic thresholds may still feel “off” for edge cases; wording must clearly
  state heuristic nature.
- If helper functions overfit to a few examples, the labels may be unstable.
- Rewriting guidance text can accidentally remove useful educational context if
  too terse.

## Assumptions and Defaults Chosen

- This pass updates both `describe_curve()` and manual-entry guidance text.
- Density is a visual heuristic, not a geometric invariant.
- Integer/GCD closure semantics must match current generator behavior.
- No changes to rendering speed/step calculations or generator output.
- Plain text console formatting is retained (no advanced terminal UI features).
