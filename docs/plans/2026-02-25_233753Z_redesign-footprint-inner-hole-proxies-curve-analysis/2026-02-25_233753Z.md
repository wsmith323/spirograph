Plan-Id: 2026-02-25_233753Z-redesign-footprint-inner-hole-proxies-curve-analysis

# Redesign Footprint + Inner-Hole Proxies for Curve Analysis (Hypotrochoid + Epitrochoid)

## Summary

Fix the broken epitrochoid `Estimated inner empty radius` analysis and
re-evaluate the related footprint proxy at the same time.

This is a broader proxy redesign (for both curve types), not just an epitrochoid
patch, because the current annulus-band density logic now depends on both:
- `estimate_curve_extent_radius(...)` (footprint proxy)
- `estimate_curve_inner_radius(...)` (hole proxy)

If either proxy is poor, the displayed density and explanatory lines drift.

This pass will:
- redesign the analytic proxies used by `curve_analysis.py`
- preserve the overall layered density architecture (structural / footprint /
  band compression)
- update tests to match the new proxy semantics and guardrails

## Goals and Success Criteria

- Make `Estimated inner empty radius` materially more believable for
  epitrochoid curves.
- Revisit `Estimated footprint radius` so it remains compatible with the new
  hole proxy and density normalization.
- Preserve stable behavior for hypotrochoid analysis unless intentionally
  improved.
- Keep the implementation analytic (no point sampling).
- Maintain explainability in console output.

Success criteria:
- Epitrochoid inner-hole proxy no longer behaves as an obviously arbitrary small
  scaled value across common parameter ranges.
- Footprint and inner-hole proxies are internally consistent (`inner <= outer`)
  and produce plausible annulus-band density adjustments.
- Tests cover both curve types for inner/outer proxy relationships and density
  monotonicity.

## In Scope

- `/Users/warren/work/projects/spirograph/spirograph/console_ui/curve_analysis.py`
- `/Users/warren/work/projects/spirograph/tests/spirograph/console_ui/test_curve_analysis.py`

## Out of Scope

- Generator math changes
- Rendering behavior changes
- `Viewport` namespace/module changes
- Random-generation constraint behavior
- Point-sampling-based analysis
- Density bucket threshold retuning (unless absolutely necessary; default is no)

## Public APIs / Interfaces / Types

No external/public API changes.

Internal helper behavior changes:
- `estimate_curve_extent_radius(...)` may change semantics (same signature)
- `estimate_curve_inner_radius(...)` will change semantics (same signature)
- `compute_active_band_compression_factor(...)` and
  `compute_visual_density_score(...)` will inherit improved proxy behavior
  without signature changes

## Design Decisions (Locked)

## 1. Keep the layered density model intact

Retain:
- `compute_density_score(metrics)` (structural)
- footprint normalization term
- annulus-band compression term

Only the proxy estimators feeding these terms are redesigned.

Reason:
- The architecture is sound; the issue is proxy quality, especially for
  epitrochoids.

## 2. Replace the epitrochoid inner-hole proxy with a geometry-derived band model (not arbitrary scaling)

Current problem:
- `inner_radius = abs((R + r) - d) * 0.15` is an arbitrary scaled term and is
  often visibly wrong.

New approach (analytic proxy redesign):
- Estimate both **outer** and **inner** radii from a shared curve-type-specific
  radial-band model, then derive:
  - `estimated_extent_radius` (outer proxy)
  - `estimated_inner_radius` (inner proxy)

This ensures outer/inner estimates are coherent and reduces ad hoc scaling.

## 3. Introduce a shared proxy helper returning both outer and inner radii

Add new internal helper (recommended):
- `_estimate_radial_band(request: CircularSpiroRequest) -> tuple[float, float]`
  returning `(inner_radius, outer_radius)`

Then:
- `estimate_curve_extent_radius(...)` becomes a thin wrapper returning `outer`
- `estimate_curve_inner_radius(...)` becomes a thin wrapper returning `inner`

Reason:
- Prevents drift between two separately maintained formulas
- Makes tests and invariants cleaner

## 4. Proxy formulas (decision-complete redesign)

Let:
- `R = request.fixed_radius`
- `r = request.rolling_radius`
- `d = request.pen_distance`

### Hypotrochoid radial-band proxy
Use the existing center-offset intuition but formalize as a band:

- `center_radius = abs(R - r)`
- `raw_inner = abs(center_radius - d)`
- `raw_outer = center_radius + d`

Then clamp:
- `outer_radius = max(1.0, raw_outer)`
- `inner_radius = min(max(0.0, raw_inner), outer_radius * 0.98)`

This is effectively what the current model approximates, but now it becomes the
explicit source for both outer and inner values.

### Epitrochoid radial-band proxy (replacing the scaled `0.15` heuristic)
Use a band centered at the carrier radius:

- `center_radius = R + r`
- `raw_inner = abs(center_radius - d)`
- `raw_outer = center_radius + d`

Then clamp:
- `outer_radius = max(1.0, raw_outer)`
- `inner_radius = min(max(0.0, raw_inner), outer_radius * 0.98)`

Why this is better:
- It is structurally parallel to the hypotrochoid proxy
- It removes arbitrary epitrochoid-specific scaling
- It tracks the obvious visual effect that changing `d` shifts radial spread and
  potential central void more strongly than the current scaled proxy suggests

Important note:
- This remains a proxy, not an exact geometric occupancy radius model.

## 5. Update footprint semantics to use the shared radial-band outer radius

`estimate_curve_extent_radius(...)` should return the `outer_radius` from the
shared radial-band helper (not an independently maintained formula).

This may change some existing epitrochoid footprint values if the current code
drifted or is later refactored, but after this redesign the semantics are
explicit and consistent.

## 6. Keep annulus-band compression math and clamps unchanged in this pass

Retain:
- `REFERENCE_ACTIVE_AREA_PROXY = REFERENCE_FOOTPRINT_RADIUS**2`
- `band_area_ratio = reference / active_area_proxy`
- `band_factor = clamp((band_area_ratio ** 0.25), 0.75, 1.6)`

Reason:
- We want to isolate the proxy redesign first.
- Any further tuning should happen after seeing the new proxy behavior.

## 7. Update output wording only if needed for correctness

Default:
- Keep current lines:
  - `Estimated footprint radius: ...`
  - `Estimated inner empty radius: ...`

Optional small clarification (only if needed after inspection):
- Add “(proxy)” to one or both labels if the values still risk being read as
  exact measurements.

Default assumption for this pass:
- Keep wording unchanged; improve the values first.

## Implementation Steps

1. Add a new internal helper to
   `/Users/warren/work/projects/spirograph/spirograph/console_ui/curve_analysis.py`
   (recommended `_estimate_radial_band(...)`) that returns `(inner, outer)` using
   the curve-type formulas above
2. Refactor `estimate_curve_extent_radius(...)` to use the shared helper’s
   `outer_radius`
3. Refactor `estimate_curve_inner_radius(...)` to use the shared helper’s
   `inner_radius`
4. Keep `compute_active_band_compression_factor(...)` and
   `compute_visual_density_score(...)` formulas unchanged (they should consume
   the improved proxies automatically)
5. Update/replace tests in
   `/Users/warren/work/projects/spirograph/tests/spirograph/console_ui/test_curve_analysis.py`
   that currently assert the old epitrochoid `* 0.15` proxy behavior
6. Add stronger invariant tests across both curve types:
   - `0 <= inner_radius <= outer_radius * 0.98`
   - outer radius responds to `d`
   - inner radius responds to `d` in expected directions for representative cases
7. Run targeted curve-analysis tests
8. Run full test suite
9. Stage changes in git (`git add ...`)
10. Run the `capture-last-plan` skill to persist this plan

## Test Cases and Scenarios

## Automated tests (pytest)

### Replace stale epitrochoid inner-radius test
Remove/replace the test that asserts:
- `inner_radius == abs((R + r) - d) * 0.15`

New epitrochoid expectations:
- `inner_radius == abs((R + r) - d)` (subject to clamp)
- `outer_radius == (R + r) + d`
- `inner_radius <= outer_radius * 0.98`

### Keep hypotrochoid proxy tests (with shared-band semantics)
Assert:
- `inner_radius == abs(abs(R-r)-d)` (subject to clamp)
- `outer_radius == abs(R-r)+d`

### Add radial-band consistency tests (both curve types)
For representative requests:
- `outer_radius >= 1.0`
- `0.0 <= inner_radius <= outer_radius * 0.98`
- increasing `d` generally increases `outer_radius`

### Annulus-band factor monotonic tests (revalidate)
- Larger hole with same/similar outer radius -> larger
  `compute_active_band_compression_factor(...)`
- Factor remains clamped within `[0.75, 1.6]`

### Visual density regression/behavior tests
- Existing structural density tests remain unchanged
- Footprint-clamp-related visual density tests may need expected-value updates if
  proxy redesign changes the annulus factor contribution for the chosen fixtures
- Keep tests focused on monotonic direction where exact values are too brittle

### Output-smoke tests
- Ensure `Estimated footprint radius` and `Estimated inner empty radius` remain
  present
- No wording changes required unless explicitly introduced

## Manual Scenarios (Console UI)

- Compare several epitrochoid curves where the current inner-hole estimate was
  obviously wrong; verify the new `Estimated inner empty radius` looks plausible.
- Compare hypotrochoid outputs to confirm no obvious regression from the proxy
  refactor.
- Check whether density labels now track your visual intuition better on
  epitrochoid examples.

## Validation Commands (Plan Defaults)

- Targeted:
  - `VIRTUAL_ENV=~/work/virtualenvs/spirograph ./scripts/test tests/spirograph/console_ui/test_curve_analysis.py -q`
- Full suite:
  - `VIRTUAL_ENV=~/work/virtualenvs/spirograph ./scripts/test -q`

## Risks / Regression Potential

- Epitrochoid proxy values may shift significantly compared to the previous
  scaled heuristic, changing visual density labels for many cases (expected).
- Exact-value tests for visual density may become brittle if they accidentally
  encode too much proxy detail; prefer invariant/monotonic assertions.
- Even the redesigned proxy is still not exact geometry occupancy.

## Assumptions and Defaults Chosen

- This pass is a broader proxy redesign (both curve types), with the primary
  motivation being epitrochoid correctness.
- The annulus-band compression architecture remains valid; only proxy inputs are
  redesigned.
- No point sampling will be introduced in this pass.
- Output wording remains unchanged unless correctness requires a small caveat.
