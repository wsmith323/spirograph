Plan-Id: 2026-02-08_152631Z-pytest-tutorial-1

# Replace Make-Based Test Runner With `scripts/test` (Inline `VIRTUAL_ENV` Pattern)

## Summary
Remove the Makefile-based test workflow and replace it with a single repo-local runner script at `/Users/warren/work/projects/spirograph/scripts/test`.

The new runner will:
- run pytest with default quiet output,
- allow subset selection via normal pytest args,
- support optional coverage,
- support optional verbose mode,
- require `VIRTUAL_ENV` explicitly (no fallback interpreter),
- standardize non-interactive/Codex usage via inline env assignment:
  - `VIRTUAL_ENV=/path/to/venv ./scripts/test ...`

## Goals and Success Criteria
- One canonical test entrypoint (`./scripts/test`) replaces `make test*`.
- No hidden interpreter behavior.
- Codex-friendly command pattern that does not depend on shell session activation.
- Existing tests still pass via new runner.
- Coverage can be enabled optionally for full suite or subsets.

## Scope
- In scope:
  - add `scripts/test`
  - remove `Makefile`
  - ensure pytest/coverage dependencies are present
  - update local contributor/agent instructions
- Out of scope:
  - runtime application logic
  - geometry/rendering behavior
  - architecture refactors

## Public Interface Changes
- Removed:
  - `/Users/warren/work/projects/spirograph/Makefile`
- Added:
  - `/Users/warren/work/projects/spirograph/scripts/test` (executable)
- Updated:
  - `/Users/warren/work/projects/spirograph/pyproject.toml` test dependency group (must include `pytest`, `pytest-cov`)
  - `/Users/warren/work/projects/spirograph/AGENTS.md` testing instructions

## Final CLI Contract for `scripts/test`
Command:
- `./scripts/test [--coverage] [--cov-target TARGET] [-v|--verbose] [pytest args...]`

### Interpreter policy
1. `VIRTUAL_ENV` is mandatory.
2. Interpreter is always `$VIRTUAL_ENV/bin/python`.
3. If `VIRTUAL_ENV` is unset:
- exit non-zero with clear error:
  - `error: VIRTUAL_ENV is not set. Run as: VIRTUAL_ENV=/path/to/venv ./scripts/test ...`
4. If `$VIRTUAL_ENV/bin/python` is missing/not executable:
- exit non-zero with clear error naming the resolved path.

### Output policy
1. Default mode:
- add `-q` automatically (quiet output).
2. Verbose mode:
- wrapper `-v` or `--verbose` adds `-v` and suppresses injected `-q`.
- if passthrough already contains `-v`, `-vv`, etc., do not inject `-q`.

### Coverage policy
1. Coverage is opt-in via `--coverage`.
2. Default cov target when enabled: `spirograph`.
3. Add flags:
- `--cov=<target>`
- `--cov-report=term-missing`
4. `--cov-target TARGET` overrides default target.

### Passthrough policy
- Any non-wrapper args are forwarded unchanged to pytest (paths, `-k`, markers, additional pytest flags).

### Help and errors
- `-h|--help` prints usage and examples, exits 0.
- Missing `--cov-target` value exits 2 with usage text.

## Implementation Plan

1. Update dependencies in `/Users/warren/work/projects/spirograph/pyproject.toml`
- Confirm `[tool.poetry.group.test.dependencies]` includes:
  - `pytest = ">=8,<10"`
  - `pytest-cov` (existing range acceptable)
- Do not add nox/tox.

2. Create `/Users/warren/work/projects/spirograph/scripts/test`
- Bash script with `set -euo pipefail`.
- Parse wrapper flags:
  - `--coverage`
  - `--cov-target <target>`
  - `-v`, `--verbose`
  - `-h`, `--help`
- Enforce `VIRTUAL_ENV` policy.
- Assemble pytest command deterministically using rules above.
- `exec` command to preserve exit code.

3. Mark script executable
- `chmod +x /Users/warren/work/projects/spirograph/scripts/test`.

4. Remove `/Users/warren/work/projects/spirograph/Makefile`
- Full removal to avoid dual workflows and stale habits.

5. Update `/Users/warren/work/projects/spirograph/AGENTS.md`
- Replace Make-based guidance with:
  - Canonical command: `VIRTUAL_ENV=/path/to/venv ./scripts/test ...`
  - Mention default quiet behavior and verbose override.
  - Mention optional coverage and cov target override.
- Explicitly note non-interactive runs should use inline `VIRTUAL_ENV=...` assignment.

6. Optional but recommended: update `/Users/warren/work/projects/spirograph/README.md`
- Add compact “Testing” section showing canonical inline env usage.

## Canonical Usage Examples
- Full suite (quiet default):
```bash
VIRTUAL_ENV=/Users/warren/work/virtualenvs/spirograph ./scripts/test
```

- Subset:
```bash
VIRTUAL_ENV=/Users/warren/work/virtualenvs/spirograph ./scripts/test tests/spirograph/generation
```

- Verbose:
```bash
VIRTUAL_ENV=/Users/warren/work/virtualenvs/spirograph ./scripts/test -v
```

- Coverage full package:
```bash
VIRTUAL_ENV=/Users/warren/work/virtualenvs/spirograph ./scripts/test --coverage
```

- Coverage scoped to module on subset:
```bash
VIRTUAL_ENV=/Users/warren/work/virtualenvs/spirograph ./scripts/test --coverage --cov-target spirograph.generation.circular_generator tests/spirograph/generation/test_circular_generator.py -q
```

## Validation Matrix

1. Baseline quiet run
- Command:
```bash
VIRTUAL_ENV=/Users/warren/work/virtualenvs/spirograph ./scripts/test
```
- Expect: tests pass; quiet output.

2. Subset passthrough (single module)
- Command:
```bash
VIRTUAL_ENV=/Users/warren/work/virtualenvs/spirograph ./scripts/test tests/spirograph/generation/test_circular_generator.py -q
```
- Expect: only that module runs; args forwarded unchanged.

3. Verbose wrapper flag
- Command:
```bash
VIRTUAL_ENV=/Users/warren/work/virtualenvs/spirograph ./scripts/test -v
```
- Expect: verbose output; no injected `-q`.

4. Passthrough verbosity precedence
- Command:
```bash
VIRTUAL_ENV=/Users/warren/work/virtualenvs/spirograph ./scripts/test tests/spirograph/generation -vv
```
- Expect: `-vv` honored; no injected `-q`.

5. Coverage default target
- Command:
```bash
VIRTUAL_ENV=/Users/warren/work/virtualenvs/spirograph ./scripts/test --coverage
```
- Expect: coverage report for `spirograph`, term-missing format.

6. Coverage custom target
- Command:
```bash
VIRTUAL_ENV=/Users/warren/work/virtualenvs/spirograph ./scripts/test --coverage --cov-target spirograph.generation.circular_generator tests/spirograph/generation/test_circular_generator.py -q
```
- Expect: module-scoped coverage report.

7. Missing `--cov-target` value
- Command:
```bash
VIRTUAL_ENV=/Users/warren/work/virtualenvs/spirograph ./scripts/test --cov-target
```
- Expect: exit code 2 + usage.

8. Missing `VIRTUAL_ENV`
- Command:
```bash
./scripts/test
```
- Expect: clear error instructing inline `VIRTUAL_ENV=...` usage; non-zero exit.

## Risks and Mitigations
- Risk: stricter env requirement may initially break habitual runs.
- Mitigation: explicit error text with exact invocation pattern.
- Risk: stale references to Make commands.
- Mitigation: remove `Makefile`; update AGENTS (and README if edited).
- Risk: wrapper/parser drift over time.
- Mitigation: keep wrapper flags minimal and pass everything else through to pytest.

## Acceptance Criteria
- `Makefile` removed.
- `scripts/test` exists, executable, and enforces mandatory `VIRTUAL_ENV`.
- `scripts/test` supports subset passthrough, optional coverage, and verbosity toggle.
- `pyproject.toml` includes `pytest` + `pytest-cov` in test group.
- `AGENTS.md` contains canonical inline env command pattern.
- All validation matrix commands behave as specified.

## Assumptions and Defaults
- No part of this replacement is considered implemented for this plan.
- Default output is quiet (`-q`) unless verbose requested.
- Coverage is opt-in and defaults to whole package target (`spirograph`).
- Inline `VIRTUAL_ENV=...` is the canonical invocation style for Codex and other non-interactive runs.
