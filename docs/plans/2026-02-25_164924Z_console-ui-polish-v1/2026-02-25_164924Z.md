Plan-Id: 2026-02-25_164924Z-console-ui-polish-v1

# Console UI Polish v1 (UX-First, No Pipeline Changes)

## Summary

Improve the console UI experience by making it more informative, less repetitive,
and safer to use during iterative exploration, while preserving current geometry,
rendering, and orchestration behavior.

This pass stays within the console/UI layer and `spirograph/main.py` flow. It
does not change generator math, render-plan color semantics, or architecture
boundaries.

## Goals and Success Criteria

- Reduce friction for common workflows (random explore, tweak session settings,
  re-run with visual changes).
- Make command/menu behavior clearer and more state-aware.
- Improve input validation feedback so users understand mistakes immediately.
- Surface performance/complexity hints before expensive renders.
- Keep manual and random workflows fully functional.
- Preserve all existing color mode semantics and randomness separation.

## In Scope

- Console menu UX in `/Users/warren/work/projects/spirograph/spirograph/main.py`
- Prompt wording and validation behavior in
  `/Users/warren/work/projects/spirograph/spirograph/console_ui/prompts.py`
- Console guidance/preview messaging in
  `/Users/warren/work/projects/spirograph/spirograph/console_ui/guidance.py`
- Small UI-only helpers/types if needed under
  `/Users/warren/work/projects/spirograph/spirograph/console_ui/`

## Out of Scope

- Persistence/save-restore features
- Renderer changes (`turtle`) beyond message/prompt usage
- Geometry generation math changes
- Architectural refactor of `main.py` into new modules (defer to later pass)

## Public APIs / Interfaces / Types

- No changes to public generation/rendering/orchestration interfaces.
- No changes to `CircularSpiroRequest`, `RenderSettings`, `CurveOrchestrator`,
  or generator/renderer contracts.
- Console command surface changes are user-facing only (CLI UX additions).

## Planned UX Improvements (Decision Complete)

## 1. Main Loop UX: add compact status header + help-on-demand

Implement a compact status line shown before the `>` prompt each loop, including:
- `curve_type`
- random constraint/evolution modes
- lock summary (`R/r/d`)
- color mode (and interval when applicable)
- line width
- drawing speed
- whether `last_request` exists

Change menu behavior:
- Stop printing the full menu every loop.
- Print the full menu at startup and on `h` / `?`.
- Keep `p` as full session status print.
- Keep current command meanings unchanged.

Reason:
- Repeated full-menu output is noisy during exploration.
- Users still need immediate visibility into current state.

## 2. State-aware session menu text

Replace the static `SESSION_MENU_TEXT` printout with a function that renders the
session menu based on current `session.color_mode`.

Behavior:
- Always show all session options numerically for discoverability.
- Mark non-applicable options 5/6/7 as `[disabled]` with reason (current color
  mode), instead of only failing after selection.
- Keep current command behavior for disabled selections (reject with message).

Reason:
- Reduces “why did that command fail?” confusion without changing logic.

## 3. Input validation polish (especially color entry)

Add explicit validation feedback for color input.

Change `prompt_color_value()` behavior:
- Accept current formats (named colors, `#RRGGBB`, `R,G,B`) exactly as today.
- If parsing fails, print a clear error and re-prompt instead of silently
  keeping the previous/default color.

Implementation detail:
- Add a parsing helper that reports success/failure (for example,
  `try_parse_color(...) -> tuple[bool, Color]` or equivalent) while preserving
  `parse_color()` for compatibility if desired.
- Standardize prompt/help wording for accepted tokens (`r`, `rand`, `random`)
  across prompts where applicable.

Reason:
- Silent fallback makes the UI feel broken.

## 4. Render preview + performance warnings before drawing

Before calling `render_request(...)` for manual/random/batch runs, print a short
preview line (or small block) summarizing:
- `steps`
- estimated laps-to-close
- estimated spins-to-close (using existing guidance logic or equivalent)
- color segmentation mode and effective interval
- warning when estimated closure complexity is high (reusing current threshold
  semantics where practical)

Behavior:
- Preserve the existing `describe_curve(...)` output.
- Add a concise “render preview” line before rendering.
- Continue warning on locked `r` causing large lap counts.
- Extend warnings to cover likely slow renders based on `steps` and/or
  high lap/spin counts, regardless of lock state.

Reason:
- Users need performance cues before a slow turtle render starts.

## 5. Add `r` command: re-render last curve with current session settings

Add a new main-menu command:
- `r` = Re-render the last generated/manual curve using current session visual
  settings (color mode, color, width, speed, interval behavior)

Behavior:
- Uses `session.last_request`; does not regenerate geometry.
- If no `last_request`, print a clear message and return to prompt.
- Works after session edits (`e`) so users can tweak color/width/speed and
  redraw immediately.

Reason:
- This is a high-value workflow shortcut with minimal code risk.

## 6. Batch mode interrupt handling

Wrap batch execution so `Ctrl-C` during batch mode:
- Stops the batch cleanly
- Prints progress summary (e.g., how many curves completed)
- Returns to main prompt instead of dumping traceback

Behavior:
- Do not suppress `KeyboardInterrupt` globally, only within batch loop handling.

Reason:
- Batch exploration is a primary workflow and currently brittle.

## 7. Command/help text consistency cleanup

Update menu/help text and prompt wording to be consistent:
- Use consistent labels (`manual`, `random`, `rerender`, `help`)
- Clarify `[Enter]` semantics in main menu
- Mention accepted alias tokens consistently where relevant
- Keep existing command letters unless specified above (`h/?`, `r` are additions)

Reason:
- Small wording changes materially improve perceived polish.

## Implementation Steps

1. Add small UI helper functions in `/Users/warren/work/projects/spirograph/spirograph/main.py` (or
   `spirograph/console_ui/` if clearly isolated) for:
   - compact main prompt status rendering
   - dynamic session menu rendering
   - render preview summary
   - shared “run request” flow to reduce duplication in `''`, `m`, and `b`
2. Update the main loop command handling in
   `/Users/warren/work/projects/spirograph/spirograph/main.py`:
   - show full menu at startup + on `h/?`
   - add `r` command
   - use shared request-run helper
   - add batch `KeyboardInterrupt` handling
3. Update color prompting in
   `/Users/warren/work/projects/spirograph/spirograph/console_ui/prompts.py` so
   invalid color input re-prompts with explicit guidance
4. Standardize prompt token/help wording in
   `/Users/warren/work/projects/spirograph/spirograph/console_ui/prompts.py`
5. Add/adjust console guidance preview messaging in
   `/Users/warren/work/projects/spirograph/spirograph/console_ui/guidance.py`
   only if needed to avoid duplicating math in `main.py`
6. Run targeted tests and manual smoke checks
7. Stage the changes in git (`git add ...`)
8. Run the `capture-last-plan` skill to persist the implementation plan

## Test Cases and Scenarios

## Automated tests (project already has a test suite, so add targeted tests)

Add tests under `tests/` for new or changed pure helpers only (no turtle UI
integration tests):
- Color parsing/validation helper behavior:
  - valid named color
  - valid hex (`#RRGGBB`)
  - valid CSV (`R,G,B`)
  - invalid input reports failure (or equivalent) instead of silent success path
- Any extracted pure formatting helpers (if added), such as:
  - lock/status summary formatting
  - interval display formatting
  - render preview classification thresholds

Use the existing pytest setup and repository conventions.

## Manual smoke checks (required for this change)

Using the console UI:
- Launch app successfully
- Random flow via `[Enter]`
- Manual flow via `m`
- Session edit flow via `e`
- Non-fixed color mode render (e.g., `random_every_n_spins`)
- `r` re-render last curve after changing line width/speed/color mode
- Batch mode `b`, then interrupt with `Ctrl-C`
- Invalid color input, confirm message + re-prompt
- `h` / `?` help menu display
- Confirm no regression in locks flow (`l`) and analysis (`a`)

## Validation Commands (Plan Defaults)

- Use the project virtualenv interpreter for agent operations:
  `~/work/virtualenvs/spirograph/bin/python`
- Run tests via repo script with explicit `VIRTUAL_ENV` as required by AGENTS:
  `VIRTUAL_ENV=~/work/virtualenvs/spirograph ./scripts/test`
- If only targeted tests are added/changed, run a focused pytest path first, then
  optionally the full suite.

## Risks / Regression Potential

- Main-loop command dispatch edits can introduce command behavior regressions if
  not covered by manual smoke checks.
- UX-only changes may accidentally alter prompt defaults or accepted inputs.
- Shared helper extraction inside `main.py` can subtly change ordering of prints;
  this is acceptable if behavior and functionality remain intact.

## Assumptions and Defaults Chosen

- This pass is UX polish only, not a structural refactor of `main.py`.
- Existing command letters remain stable, with only additive commands (`h/?`, `r`).
- Existing color/random semantics remain unchanged.
- Existing `describe_curve(...)` output remains; preview is additive.
- Performance warnings are heuristic and informational only (no blocking prompts).
- No persistence/session save-restore work in this pass.
