Plan-Id: 2026-02-25_223732Z-size-aware-visual-density-shared-viewport-namespace

# Size-Aware Visual Density + Shared Viewport Namespace (Class-Based, Decoupled)

## Summary

Revise the size-aware density update so viewport/screen dimensions are defined
once in a neutral module and exposed via a class namespace (`Viewport`) that
both the turtle renderer and `curve_analysis.py` can use without coupling those
components.

This is a combined unit of work with two discrete changes:

1. **Shared viewport namespace extraction (infrastructure)**  
   Introduce a top-level neutral module containing a `Viewport` class with
   screen dimensions and derived values.

2. **Size-aware visual density (behavior)**  
   Implement footprint-normalized visual density in
   `spirograph/console_ui/curve_analysis.py`, using the shared `Viewport`
   values.

## Goals and Success Criteria

- Eliminate duplicated screen-size values across renderer and analysis code.
- Keep renderer and console analysis decoupled (no cross-layer imports).
- Use a clean namespace (`Viewport`) instead of flat prefixed constants.
- Make `Visual density estimate` size-aware so larger curves can appear less
  dense than similarly complex smaller curves.
- Preserve existing structural density helper semantics and density buckets.

Success criteria:
- `turtle_renderer.py` and `curve_analysis.py` both import `Viewport` from the
  same neutral module.
- No duplicated screen-size literals remain in those files.
- Size-aware density tests pass and show the expected footprint effect.
- Full test suite remains green.

## In Scope

- New neutral viewport module:
  `/Users/warren/work/projects/spirograph/spirograph/viewport.py`
- `/Users/warren/work/projects/spirograph/spirograph/rendering/turtle_renderer.py`
- `/Users/warren/work/projects/spirograph/spirograph/console_ui/curve_analysis.py`
- `/Users/warren/work/projects/spirograph/tests/spirograph/console_ui/test_curve_analysis.py`

## Out of Scope

- Generator math changes
- Render behavior beyond replacing hardcoded viewport dimensions
- Console input guidance text changes
- Symmetry/perceived-symmetry logic changes
- Density bucket threshold changes
- Runtime-configurable window sizing

## Public APIs / Interfaces / Types

No external/public API changes.

New internal module and class:
- `spirograph.viewport.Viewport`

Internal usage changes:
- `TurtleGraphicsRenderer` reads dimensions from `Viewport`
- `curve_analysis.py` derives density normalization context from `Viewport`

## Design Decisions (Locked)

## 1. Neutral shared module + class namespace

Create:
- `/Users/warren/work/projects/spirograph/spirograph/viewport.py`

Define class:
- `Viewport` (recommended spelling; not `ViewPort`)

Reason:
- Neutral location avoids rendering/UI coupling
- Class namespace is cleaner than `VIEWPORT_*` globals

## 2. `Viewport` class shape (single source of truth)

Define class attributes only (no instances needed):

- `Viewport.WIDTH = 1000.0`
- `Viewport.HEIGHT = 1000.0`
- `Viewport.HALF_WIDTH = Viewport.WIDTH / 2.0`
- `Viewport.HALF_HEIGHT = Viewport.HEIGHT / 2.0`
- Optional convenience:
  - `Viewport.MIN_DIMENSION = min(Viewport.WIDTH, Viewport.HEIGHT)`

Notes:
- Use float values for analysis math consistency
- Renderer may cast to `int` for turtle setup

## 3. Update renderer to consume `Viewport`

In `spirograph/rendering/turtle_renderer.py`:
- Replace `self._screen.setup(width=1000, height=1000)` with:
  - `width=int(Viewport.WIDTH)`
  - `height=int(Viewport.HEIGHT)`

No other renderer behavior changes.

## 4. Preserve structural density helper; add visual-density layer

In `spirograph/console_ui/curve_analysis.py`:
- Keep `compute_density_score(metrics)` unchanged as structural density
- Add size-aware helpers:
  - `estimate_curve_extent_radius(request)`
  - `compute_visual_density_score(metrics, request)`
  - optional `_clamp(...)`

Displayed `Visual density estimate` should use the size-adjusted score.

## 5. Footprint proxy and normalization (viewport-derived reference radius)

Footprint proxy (exact):
- Hypotrochoid: `abs(R - r) + d`
- Epitrochoid: `R + r + d`
- Clamp extent radius to `>= 1.0`

Reference radius (derived from shared viewport class):
- `REFERENCE_FOOTPRINT_RADIUS = min(Viewport.HALF_WIDTH, Viewport.HALF_HEIGHT) * 0.45`

With current viewport, this resolves to `225.0`, but it should be derived, not
duplicated.

Normalization (exact):
- `footprint_scale = estimated_extent_radius / REFERENCE_FOOTPRINT_RADIUS`
- `clamped_footprint_scale = min(1.75, max(0.65, footprint_scale))`
- `visual_density_score = structural_density_score / clamped_footprint_scale`

## 6. Keep displayed label; add footprint context line

Keep:
- `Visual density estimate: <Low|Medium|High|Very High>`

Behavior:
- classify `visual_density_score` instead of structural score

Add one line for transparency:
- `Estimated footprint radius: ~<rounded_value> (larger curves can appear less dense)`

Preserve current manual wording/formatting in `describe_curve()` except:
- density now size-aware
- added footprint line

## Implementation Steps

1. Create `/Users/warren/work/projects/spirograph/spirograph/viewport.py` with
   the `Viewport` class and class attributes listed above
2. Update `/Users/warren/work/projects/spirograph/spirograph/rendering/turtle_renderer.py`
   to import `Viewport` and use `Viewport.WIDTH` / `Viewport.HEIGHT`
3. Update `/Users/warren/work/projects/spirograph/spirograph/console_ui/curve_analysis.py`:
   - import `Viewport`
   - add `estimate_curve_extent_radius(...)`
   - add `compute_visual_density_score(...)`
   - derive `REFERENCE_FOOTPRINT_RADIUS` from `Viewport.HALF_*`
   - use visual (size-adjusted) score for displayed density classification
   - add `Estimated footprint radius` output line
4. Keep `compute_density_score(...)` and `classify_density(...)` unchanged
5. Extend
   `/Users/warren/work/projects/spirograph/tests/spirograph/console_ui/test_curve_analysis.py`
   with:
   - footprint estimation tests
   - visual density monotonicity tests
   - clamp behavior tests
   - output-smoke assertion for `Estimated footprint radius`
6. Run targeted curve analysis tests
7. Run full test suite
8. Stage changes in git (`git add ...`)
9. Run the `capture-last-plan` skill to persist this revised plan

## Test Cases and Scenarios

## Automated tests (pytest)

### Structural density regression (unchanged behavior)
- Existing `compute_density_score(...)` tests still pass unchanged
- Existing `classify_density(...)` threshold tests still pass unchanged

### New footprint estimation tests
- Hypotrochoid extent = `abs(R-r)+d`
- Epitrochoid extent = `R+r+d`
- Extent clamped to `>= 1.0` where relevant

### New visual density normalization tests
- Same `RepeatMetrics`, larger-footprint request -> lower visual density score
- Same `RepeatMetrics`, smaller-footprint request -> higher visual density score
- Clamp floor (`0.65`) and ceiling (`1.75`) behavior verified

### Output-smoke test updates
Assert `describe_curve()` output contains:
- `Curve analysis:`
- `Visual density estimate`
- `Estimated footprint radius`
- existing current labels (matching your current wording)
- no obsolete labels you no longer emit

## Manual Scenarios (Console UI)

- Compare two curves with similar repeat complexity but different overall size;
  confirm larger footprint tends to reduce displayed visual density.
- Verify the new footprint line helps explain density differences.
- Confirm turtle window still opens at the same dimensions as before.

## Validation Commands (Plan Defaults)

- Targeted:
  - `VIRTUAL_ENV=~/work/virtualenvs/spirograph ./scripts/test tests/spirograph/console_ui/test_curve_analysis.py -q`
- Full suite:
  - `VIRTUAL_ENV=~/work/virtualenvs/spirograph ./scripts/test -q`

## Risks / Regression Potential

- Footprint proxy is approximate (extent radius, not exact occupied area)
- Changing `Viewport` dimensions later will intentionally affect normalization
- Output-smoke tests may need updates if wording changes again

## Assumptions and Defaults Chosen

- Shared viewport values should be namespaced under a `Viewport` class
- `Viewport` lives in a neutral top-level module: `spirograph/viewport.py`
- `Visual density estimate` becomes size-aware (single displayed value)
- Structural density remains available via `compute_density_score(metrics)`
- Current user-edited `describe_curve()` wording/format should be preserved
  except for the density behavior change and added footprint line
