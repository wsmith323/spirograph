Plan-Id: 2026-02-25_231520Z-hole-aware-annulus-band-visual-density-refinement

# Hole-Aware (Annulus-Band) Visual Density Refinement for Curve Analysis

## Summary

Refine the current size-aware `Visual density estimate` in
`/Users/warren/work/projects/spirograph/spirograph/console_ui/curve_analysis.py`
to account for **center-hole size / active band width**.

Key correction:
- A larger center hole can make a curve look **more dense** (not less) when
  similar structural complexity is compressed into a narrower annular region.

This pass keeps the current:
- structural density score (`compute_density_score`)
- viewport-based footprint normalization
- density buckets (`Low`, `Medium`, `High`, `Very High`)
- shared `Viewport` namespace approach

It adds an **annulus-band compression factor** on top of the existing
footprint-normalized score.

## Goals and Success Criteria

- Improve perceived-density accuracy for curves with large center holes.
- Increase visual density score when the active drawing band is narrower (all
  else equal).
- Preserve the current size-aware footprint normalization as a separate factor.
- Keep the implementation cheap (analytic proxy only; no point sampling).

Success criteria:
- Two curves with similar structural complexity and similar outer footprint but
  different center-hole size can yield different density scores in the expected
  direction (larger hole -> denser appearance).
- Existing structural-density and footprint-normalization tests continue to pass
  (or are updated only where intended behavior changed).
- New tests cover annulus-band factor monotonic behavior.

## In Scope

- `/Users/warren/work/projects/spirograph/spirograph/console_ui/curve_analysis.py`
- `/Users/warren/work/projects/spirograph/tests/spirograph/console_ui/test_curve_analysis.py`

## Out of Scope

- Generator math changes
- Renderer behavior changes
- Viewport constant definitions (`spirograph/viewport.py`)
- Console input guidance text changes
- Symmetry/perceived-symmetry logic changes
- Density bucket threshold changes
- Point-sampling-based density estimation

## Public APIs / Interfaces / Types

No external/public API changes.

Internal additions in `curve_analysis.py`:
- New pure helper(s) for annulus-band geometry proxy and compression factor
- `compute_visual_density_score(...)` behavior changes (same signature)

## Design Decisions (Locked)

## 1. Keep a layered density model (do not replace existing factors)

Final displayed visual density remains layered:

- `structural_density` (existing `compute_density_score(metrics)`)
- `/ footprint_scale` (existing size normalization)
- `* band_compression_factor` (new annulus-band adjustment)

This keeps the model interpretable and avoids retuning the structural score.

## 2. Use analytic annulus proxy (no point sampling)

Use cheap radius proxies derived from `R`, `r`, `d`, and `curve_type`.

Reason:
- User selected analytic proxy
- Fast, deterministic, and consistent with current `curve_analysis.py` style
- Avoids tighter coupling to generated points

## 3. Estimate outer radius using existing footprint proxy

Reuse current helper:
- `outer_radius = estimate_curve_extent_radius(request)`

Do not duplicate a separate outer-radius formula.

## 4. Add an estimated inner radius proxy (hole size)

Introduce a new helper:
- `estimate_curve_inner_radius(request: CircularSpiroRequest) -> float`

### Exact proxy formulas (decision-complete)

Let:
- `R = request.fixed_radius`
- `r = request.rolling_radius`
- `d = request.pen_distance`

For `hypotrochoid`:
- Center path radius term: `abs(R - r)`
- Estimated inner hole radius proxy:
  - `inner_radius = max(0.0, abs(abs(R - r) - d))`

For `epitrochoid`:
- Outer footprint already uses `R + r + d`
- Epitrochoids can still have central empty regions depending on geometry, but
  the hole is less directly captured by a single “difference” term
- Use a conservative proxy:
  - `inner_radius = max(0.0, abs((R + r) - d) * 0.15)`

Rationale for epitrochoid proxy:
- Keeps some hole sensitivity without overstating it
- Avoids implying a strong exact analytic invariant where there isn’t one in
  this simplified model
- Easy to tune later if manual calibration suggests adjustment

Clamp:
- `inner_radius = min(inner_radius, outer_radius * 0.98)`

Reason:
- Prevents zero/negative active-band area and extreme singular behavior.

## 5. Compute active annulus area proxy and compression factor

Add helper:
- `compute_active_band_compression_factor(request: CircularSpiroRequest) -> float`

Compute:
- `outer_radius = estimate_curve_extent_radius(request)`
- `inner_radius = estimate_curve_inner_radius(request)`
- `active_area_proxy = max(1.0, outer_radius**2 - inner_radius**2)`

Reference active area proxy (derived from current outer-footprint reference):
- `REFERENCE_ACTIVE_AREA_PROXY = REFERENCE_FOOTPRINT_RADIUS**2`

Compression ratio:
- `band_area_ratio = REFERENCE_ACTIVE_AREA_PROXY / active_area_proxy`

Interpretation:
- Smaller active annulus area -> larger ratio -> denser perceived packing

Clamp factor before applying:
- `clamped_band_factor = min(1.6, max(0.75, band_area_ratio ** 0.25))`

Reason:
- 4th-root softens the area-ratio effect (area scales quadratically)
- Clamp prevents overcorrection and unstable labels

## 6. Update visual density score composition

Revise `compute_visual_density_score(metrics, request)`:

Current:
- `structural_density / clamped_footprint_scale`

New:
- `(structural_density / clamped_footprint_scale) * clamped_band_factor`

Keep:
- footprint normalization clamp (`0.65 .. 1.75`) unchanged

This means:
- larger overall footprint still lowers density
- larger center hole (narrower active band) can raise density

## 7. Add analysis output transparency line for hole/band effect

Keep current `Estimated footprint radius` line.

Add one additional line:
- `Estimated inner empty radius: ~<rounded_value> (larger hole can increase perceived density)`

Recommended placement (aligned with current output style):
1. `Visual density estimate: ...`
2. `Estimated footprint radius: ...`
3. `Estimated inner empty radius: ...`
4. `Notes: ...`

This makes the new effect explainable to users.

## 8. Keep density buckets unchanged

Do not retune `classify_density(...)` in this pass.
Any threshold tuning should happen only after manual calibration.

## Helper Functions to Add (Pure, in `curve_analysis.py`)

Add:
- `estimate_curve_inner_radius(request: CircularSpiroRequest) -> float`
- `compute_active_band_compression_factor(request: CircularSpiroRequest) -> float`

Optional internal helpers if clarity improves:
- `_safe_active_area_proxy(outer_radius: float, inner_radius: float) -> float`

Keep existing helpers intact:
- `estimate_curve_extent_radius(...)`
- `compute_density_score(...)`
- `compute_visual_density_score(...)` (behavior updated, signature unchanged)

## Implementation Steps

1. Add `estimate_curve_inner_radius(...)` to
   `/Users/warren/work/projects/spirograph/spirograph/console_ui/curve_analysis.py`
   using the exact curve-type proxy formulas and clamping rules above
2. Add `compute_active_band_compression_factor(...)` in the same module using:
   - annulus-area proxy
   - reference area from `REFERENCE_FOOTPRINT_RADIUS`
   - 4th-root softening and clamp (`0.75 .. 1.6`)
3. Update `compute_visual_density_score(...)` to multiply the existing
   footprint-normalized score by the band compression factor
4. Update `describe_curve()` to:
   - compute `estimated_inner_radius`
   - print `Estimated inner empty radius` line
   - keep current manual output wording/layout otherwise unchanged
5. Extend
   `/Users/warren/work/projects/spirograph/tests/spirograph/console_ui/test_curve_analysis.py`
   with:
   - inner-radius proxy tests (hypo/epi)
   - annulus-band factor monotonic tests (larger hole -> larger factor under
     controlled outer radius assumptions)
   - output-smoke assertion for `Estimated inner empty radius`
6. Run targeted curve analysis tests
7. Run full test suite
8. Stage changes in git (`git add ...`)
9. Run the `capture-last-plan` skill to persist this plan

## Test Cases and Scenarios

## Automated tests (pytest)

### Regression tests (unchanged)
- `compute_density_score(...)` examples remain unchanged
- `classify_density(...)` thresholds unchanged
- Existing footprint normalization tests still pass unless intentionally updated
  for new `compute_visual_density_score(...)` composition

### New inner-radius proxy tests
- Hypotrochoid:
  - verify `inner_radius ~= abs(abs(R-r)-d)` (clamped)
- Epitrochoid:
  - verify proxy formula is applied and clamped below outer radius
- Inner radius never negative
- Inner radius never exceeds `outer_radius * 0.98`

### New annulus-band factor tests
- For controlled requests with similar outer radius, larger estimated inner hole
  -> larger `compute_active_band_compression_factor(...)`
- Factor clamp floor and ceiling behavior
- Factor remains finite and positive

### Updated visual density tests
- Same `RepeatMetrics` and similar footprint, larger hole -> higher
  `compute_visual_density_score(...)`
- Existing larger-footprint -> lower visual density trend still holds in a case
  where hole-size effect does not dominate

### Output-smoke test updates
Assert `describe_curve()` output contains:
- `Visual density estimate`
- `Estimated footprint radius`
- `Estimated inner empty radius`
- current wording labels already in use (`Perceived symmetry while rendering`,
  etc.)

## Manual Scenarios (Console UI)

- Compare curves with similar outer size and repeat complexity but noticeably
  different center-hole size; confirm larger-hole curve tends to get a higher
  visual density estimate.
- Compare a large-footprint curve and compact-footprint curve to confirm
  footprint normalization still matters.
- Verify the new inner-radius line makes the density behavior easier to explain.

## Validation Commands (Plan Defaults)

- Targeted:
  - `VIRTUAL_ENV=~/work/virtualenvs/spirograph ./scripts/test tests/spirograph/console_ui/test_curve_analysis.py -q`
- Full suite:
  - `VIRTUAL_ENV=~/work/virtualenvs/spirograph ./scripts/test -q`

## Risks / Regression Potential

- Epitrochoid inner-hole proxy is a heuristic and may need calibration.
- Combining footprint and annulus compression can overcorrect in some cases
  without careful clamping (mitigated by root softening + clamps).
- Output-smoke tests are sensitive to wording changes.

## Assumptions and Defaults Chosen

- The current size-aware density model stays in place and is refined, not
  replaced.
- Annulus-band compression should increase perceived density when the center hole
  is larger (with similar outer footprint/complexity).
- Analytic proxies are preferred over sampling generated points in this pass.
- Current `describe_curve()` wording/format remains mostly intact; only a new
  inner-hole context line is added.
